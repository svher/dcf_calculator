<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全域风险团伙审核 - 实时化方案设计</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.1/mermaid.min.js"></script>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/sql.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .mermaid-container {
            cursor: default;
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #21252b;
        }

        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 5px;
            border: 2px solid #21252b;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        pre {
            margin: 0;
            height: 100%;
            width: 100%;
            overflow: auto;
        }

        code.hljs {
            font-family: 'Fira Code', monospace;
            font-size: 13px;
            line-height: 1.6;
            min-height: 100%;
            padding: 0.5rem 1rem 2rem 0.5rem !important;
            white-space: pre;
            display: block;
            background-color: #282c34;
            color: #abb2bf;
        }

        .code-placeholder {
            color: #5c6370;
            font-style: italic;
        }

        .resizer {
            width: 12px;
            background: #21252b;
            cursor: col-resize;
            transition: background 0.2s;
            position: relative;
            z-index: 50;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-left: 1px solid #181a1f;
            border-right: 1px solid #181a1f;
        }

        .resizer:hover,
        .resizer.resizing {
            background: #3b82f6;
            border-color: #2563eb;
        }

        .resizer::after {
            content: "";
            height: 24px;
            width: 4px;
            background: #4b5563;
            border-radius: 2px;
            display: block;
        }

        .resizer:hover::after,
        .resizer.resizing::after {
            background: white;
        }

        body.resizing {
            cursor: col-resize;
            user-select: none;
        }

        body.resizing iframe {
            pointer-events: none;
        }

        .hljs-ln-numbers {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
            text-align: right;
            color: #495162;
            border-right: 1px solid #495162;
            vertical-align: top;
            padding-right: 10px !important;
            padding-left: 0px !important;
            min-width: 40px;
        }

        .hljs-ln-code {
            padding-left: 15px !important;
        }

        /* Smooth scroll */
        .hljs {
            scroll-behavior: smooth;
        }

        /* Highlight target line */
        @keyframes highlight-flash {
            0% {
                background-color: #3b82f6;
            }

            100% {
                background-color: transparent;
            }
        }

        .highlight-line {
            animation: highlight-flash 2s ease-out;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e' }
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-slate-50 text-slate-900 overflow-hidden h-screen flex flex-col">

    <header
        class="bg-white border-b border-slate-200 shadow-sm z-10 px-6 py-4 flex justify-between items-center h-16 shrink-0">
        <div class="flex items-center gap-3">
            <div class="h-8 w-8 bg-brand-600 rounded-lg flex items-center justify-center text-white font-bold text-lg">G
            </div>
            <div>
                <h1 class="text-base font-bold text-slate-800">全域风险团伙审核实时化</h1>
                <p class="text-[10px] text-slate-500 font-medium uppercase tracking-wider">Real-time Architecture
                    Visualization</p>
            </div>
        </div>
        <div class="flex items-center gap-2 text-sm text-slate-500">
            <span id="status-indicator"
                class="flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-green-50 text-green-700 text-xs font-medium border border-green-100">
                <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span> Ready
            </span>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden" id="main-split-view">

        <main class="flex-1 relative bg-slate-50 flex flex-col min-w-[300px]" id="left-pane" style="width: 50%;">
            <div
                class="absolute top-4 left-4 z-10 bg-white/90 backdrop-blur px-3 py-1.5 rounded-full text-xs font-semibold text-brand-600 shadow-sm border border-brand-100 flex items-center gap-2">
                <button id="back-btn" onclick="backToMain()"
                    class="hidden hover:bg-brand-50 p-1 rounded-full transition">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                </button>
                <span id="graph-title">Dependency Graph</span>
            </div>

            <div id="graph-container" class="flex-1 w-full h-full flex items-center justify-center p-4 overflow-auto">
                <!-- Main dependency graph -->
                classDef final fill:#f0fdf4,stroke:#22c55e,stroke-width:2px,color:#166534;

                subgraph Level0 ["Level 0: Raw Data"]
                direction TB
                GroupLink["shop_fusion_link_group_v1<br>(团伙关系)"]:::origin
                ShopAttr["dim_slr_shop_ext_df<br>(商家属性)"]:::origin
                PenaltyTicket["dwd_gvn_penalty_ticket_info_df<br>(罚单信息)"]:::origin
                JudgeRecord["dwd_gvn_penalty_judge_record_df<br>(判罚详情)"]:::origin
                OrderData["dm_aftersale_order_status_df<br>(订单数据)"]:::origin
                end

                subgraph Level1 ["Level 1: Parsing"]
                ParseScript["底线违规商品映射解析_*.py"]:::process
                ParsedSeed["groupaudit_shop_seed_penalize_product_info"]
                end

                subgraph Level2 ["Level 2: Assembly"]
                BaseDataSQL["全域风险团伙审核_召回_团伙基础数据.sql"]:::process
                OriginGroup["groupaudit_shop_recallstrategy_v1_origin_groupshopinfo"]
                end

                subgraph Level3 ["Level 3: Pre-Filtering"]
                FilterSQL["全域风险团伙审核_召回_团伙种子过滤_*.sql"]:::process
                FilterGroup["groupaudit_shop_recallstrategy_v1_filter_groupshopinfo"]
                end

                subgraph Level4 ["Level 4: Python Complex Rules"]
                RuleScript["全域风险团伙审核_召回_团伙规则过滤_*.py"]:::process
                ResultGroup["groupaudit_shop_recallstrategy_v1_result_groupshopinfo"]
                end

                subgraph Level5 ["Level 5: Final Aggregation"]
                SummaryScript["全域风险团伙审核_召回_汇总.py"]:::final
                FinalTable["groupaudit_shop_recallstrategy_v1_groupshopinfo"]:::final
                HistoryData[("History State 7 Days")]
                end

                PenaltyTicket --> ParseScript
                JudgeRecord --> ParseScript
                ParseScript --> ParsedSeed

                GroupLink --> BaseDataSQL
                ShopAttr --> BaseDataSQL
                OrderData --> BaseDataSQL
                ParsedSeed --> BaseDataSQL

                BaseDataSQL --> OriginGroup

                OriginGroup --> FilterSQL
                PenaltyTicket --> FilterSQL

                FilterSQL --> FilterGroup

                FilterGroup --> RuleScript
                RuleScript --> ResultGroup

                ResultGroup --> SummaryScript
                HistoryData --> SummaryScript
                SummaryScript --> FinalTable
            </div>

            <!-- Detailed flow graphs (hidden by default) -->
            <div class="mermaid w-full h-full hidden" id="detail-SummaryScript">
                graph TD
                classDef data fill:#e0f2fe,stroke:#0284c7,stroke-width:2px;
                classDef logic fill:#fae8ff,stroke:#a855f7,stroke-width:2px;
                classDef output fill:#dcfce7,stroke:#16a34a,stroke-width:2px;

                Start([开始]):::logic
                LoadToday["读取今日数据<br>today_data_sql"]:::data
                LoadHistory["读取历史数据<br>history_data_sql<br>(last 7 days)"]:::data

                BuildDict["构建历史字典<br>history_shop_link_seed_dict<br>shop_id → [seed_lists]"]:::logic

                FilterLoop["遍历今日数据<br>提取 seed_shop_list"]:::logic
                SubsetCheck{"子集检查<br>current_seeds ⊆ history_seeds?"}:::logic
                Filter["filter_sign = 1<br>过滤掉"]:::logic
                Keep["filter_sign = 0<br>保留"]:::logic

                Collect["收集 valid_idx_list"]:::logic
                Extract["提取有效数据<br>valid_jh_data"]:::output
                SaveHive["保存到 Hive<br>groupaudit_shop_recallstrategy<br>_v1_groupshopinfo"]:::output

                Start --> LoadToday
                Start --> LoadHistory
                LoadToday --> BuildDict
                LoadHistory --> BuildDict
                BuildDict --> FilterLoop
                FilterLoop --> SubsetCheck
                SubsetCheck -->|Yes| Filter
                SubsetCheck -->|No| Keep
                Keep --> Collect
                Filter --> FilterLoop
                Collect --> Extract
                Extract --> SaveHive
            </div>

            <div class="mermaid w-full h-full hidden" id="detail-RuleScript">
                graph TD
                classDef data fill:#e0f2fe,stroke:#0284c7,stroke-width:2px;
                classDef logic fill:#fae8ff,stroke:#a855f7,stroke-width:2px;
                classDef output fill:#dcfce7,stroke:#16a34a,stroke-width:2px;

                Start([开始]):::logic
                Load["读取筛选后数据<br>groupaudit_shop_recallstrategy<br>_v1_filter_groupshopinfo"]:::data

                Group["按 group_id 分组"]:::logic
                Sort["排序商家<br>(is_seed DESC,<br>has_new_product DESC,<br>random)"]:::logic

                CheckSize{"group_size > 10?"}:::logic
                Split["切分子群组<br>split_chunks(10)"]:::logic
                Keep["保持原样"]:::logic

                BuildJSON["构建 shop_infos JSON<br>- 罚单详情<br>- 品牌信息<br>- 种子关系"]:::logic
                SaveHive["保存到 Hive<br>groupaudit_shop_recallstrategy<br>_v1_result_groupshopinfo"]:::output

                Start --> Load
                Load --> Group
                Group --> Sort
                Sort --> CheckSize
                CheckSize -->|Yes| Split
                CheckSize -->|No| Keep
                Split --> BuildJSON
                Keep --> BuildJSON
                BuildJSON --> SaveHive
            </div>

            <div class="mermaid w-full h-full hidden" id="detail-FilterSQL">
                graph TD
                classDef data fill:#e0f2fe,stroke:#0284c7,stroke-width:2px;
                classDef logic fill:#fae8ff,stroke:#a855f7,stroke-width:2px;
                classDef output fill:#dcfce7,stroke:#16a34a,stroke-width:2px;

                Start([开始]):::logic
                Origin["读取原始表<br>groupaudit_shop_recallstrategy<br>_v1_origin_groupshopinfo"]:::data
                Penalty["LEFT JOIN 罚单表<br>dwd_gvn_penalty_ticket_info_df<br>(rule_id = 216949)"]:::data

                Window1["计算窗口函数<br>group_jh_seed_cnt<br>(假货种子数)"]:::logic
                Window2["计算窗口函数<br>group_has_auditproduct_shop_cnt<br>(待审核商家数)"]:::logic
                Window3["计算窗口函数<br>group_worth_reejctandpenalize<br>_jh_seed_cnt<br>(严重种子数)"]:::logic

                Filter["WHERE 条件过滤<br>seed_cnt ≥ 1<br>severe_seed_cnt ≥ 1<br>audit_shop_cnt ≥ 3"]:::logic
                Insert["INSERT OVERWRITE<br>groupaudit_shop_recallstrategy<br>_v1_filter_groupshopinfo"]:::output

                Start --> Origin
                Origin --> Penalty
                Penalty --> Window1
                Window1 --> Window2
                Window2 --> Window3
                Window3 --> Filter
                Filter --> Insert
            </div>

            <div class="mermaid w-full h-full hidden" id="detail-BaseDataSQL">
                graph TD
                classDef data fill:#e0f2fe,stroke:#0284c7,stroke-width:2px;
                classDef logic fill:#fae8ff,stroke:#a855f7,stroke-width:2px;
                classDef output fill:#dcfce7,stroke:#16a34a,stroke-width:2px;

                Start([开始]):::logic

                CTE1["CTE: group_base_data<br>从 shop_fusion_link_group_v1<br>JOIN dim_slr_shop_ext_df<br>筛选
                group_size ≥ 3"]:::data

                CTE2["CTE: shop_main_cate<br>计算商家主营类目"]:::data

                CTE3["CTE: seed_penalize_data<br>关联罚单 + 商品解析结果<br>构建违规详情"]:::data

                Join1["LEFT JOIN<br>假货种子罚单 (B1)"]:::logic
                Join2["LEFT JOIN<br>劣质种子罚单 (B2)"]:::logic
                Join3["LEFT JOIN<br>虚假宣传种子罚单 (B3)"]:::logic
                Join4["LEFT JOIN<br>商品信息 (C)"]:::logic
                Join5["LEFT JOIN<br>订单信息 (D)"]:::logic
                Join6["LEFT JOIN<br>强关联群组 (E)"]:::logic

                Insert["INSERT OVERWRITE<br>groupaudit_shop_recallstrategy<br>_v1_origin_groupshopinfo"]:::output

                Start --> CTE1
                Start --> CTE2
                Start --> CTE3

                CTE1 --> Join1
                CTE3 --> Join1
                Join1 --> Join2
                Join2 --> Join3
                Join3 --> Join4
                Join4 --> Join5
                Join5 --> Join6
                Join6 --> Insert
            </div>

            <div class="mermaid w-full h-full hidden" id="detail-ParseScript">
                graph TD
                classDef data fill:#e0f2fe,stroke:#0284c7,stroke-width:2px;
                classDef logic fill:#fae8ff,stroke:#a855f7,stroke-width:2px;
                classDef output fill:#dcfce7,stroke:#16a34a,stroke-width:2px;

                Start([开始]):::logic
                Query["查询罚单数据<br>dwd_gvn_penalty_ticket_info_df<br>JOIN dwd_gvn_penalty_judge_record_df<br>(rule_id
                in (...))"]:::data

                Loop["遍历每条罚单记录"]:::logic

                Try1["尝试解析<br>recall_product_verify_result<br>→ verified_order_info<br>→ product_id"]:::logic

                Try2["尝试解析<br>violation_detail:commodity_id<br>清理分隔符"]:::logic

                Try3["尝试解析<br>violation_detail:product_id<br>清理分隔符"]:::logic

                Dedupe["去重 product_id_list"]:::logic
                Expand["展开为多行<br>(shop_id, penalize_id, product_id)"]:::logic

                SaveHive["保存到 Hive<br>groupaudit_shop_seed<br>_penalize_product_info"]:::output

                Start --> Query
                Query --> Loop
                Loop --> Try1
                Try1 --> Try2
                Try2 --> Try3
                Try3 --> Dedupe
                Dedupe --> Expand
                Expand --> Loop
                Loop --> SaveHive
            </div>
    </div>
    </main>

    <div class="resizer" id="drag-handle"></div>

    <aside class="relative bg-[#282c34] shadow-xl z-20 flex flex-col min-w-[300px]" id="right-pane" style="width: 50%;">
        <div class="h-12 border-b border-black/20 flex items-center justify-between px-4 bg-[#21252b] shrink-0">
            <div class="flex items-center gap-4 overflow-hidden flex-1">
                <div class="flex items-center gap-2 overflow-hidden max-w-[50%]">
                    <svg class="w-4 h-4 text-brand-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                    <span id="current-filename" class="text-xs font-mono font-medium text-slate-300 truncate"
                        title="Select a file">Select a file</span>
                </div>

                <div class="flex bg-slate-800 p-0.5 rounded-lg border border-slate-700">
                    <button onclick="switchMode('simplified')" id="tab-simplified"
                        class="px-3 py-1 text-[10px] font-medium rounded-md text-white bg-brand-600 transition-all">Simplified</button>
                    <button onclick="switchMode('original')" id="tab-original"
                        class="px-3 py-1 text-[10px] font-medium rounded-md text-slate-400 hover:text-slate-200 transition-all">Original</button>
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="copyCode()"
                    class="text-[10px] bg-slate-700 hover:bg-slate-600 px-2 py-0.5 rounded text-slate-300 border border-slate-600 transition">COPY</button>
                <span
                    class="text-[10px] bg-brand-900/50 px-2 py-0.5 rounded text-brand-200 font-medium border border-brand-800"
                    id="lang-tag">TEXT</span>
            </div>
        </div>

        <div class="flex-1 bg-[#282c34] relative h-full w-full overflow-hidden">
            <pre class="h-full w-full m-0"><code id="code-content" class="hljs language-plaintext code-placeholder">// Select a node on the left to view code.
// Toggle between 'Simplified' and 'Original' tabs above.</code></pre>
        </div>
    </aside>
    </div>

    <!-- Simplified Content (Embedded) -->
    <script type="text/template" id="content-SummaryScript-simplified" data-name="全域风险团伙审核_召回_汇总.py" data-lang="python"># %% 核心逻辑: 基于历史7天数据去重
# 如果当前群组的种子集合是历史群组种子集合的子集，则过滤

# 读取今日和历史数据
today_data = sql(today_data_sql).toPandas()
history_data = sql(history_data_sql).toPandas()

# 构建历史字典: 商家 -> 其关联过的所有种子集合
history_shop_link_seed_dict = {}
for idx in range(len(temp_history_data)):
    group_shop_info = eval(temp_history_data['shop_infos'].iloc[idx])
    seed_shop_list = []
    group_shop_list = []
    for shop_info in group_shop_info:
        shop_id = shop_info['shop_id']
        is_black_seed = shop_info['is_black_seed']
        if is_black_seed == 1:
            seed_shop_list.append(shop_id)
        group_shop_list.append(shop_id)
    for shop_id in group_shop_list:
        if shop_id not in history_shop_link_seed_dict:
            history_shop_link_seed_dict[shop_id] = []
        history_shop_link_seed_dict[shop_id].append(seed_shop_list)

# 过滤当前数据 (核心逻辑)
valid_idx_list = []
for idx in range(len(temp_today_data)):
    # ... 获取当前种子集合 ...
    filter_sign = 0
    if shop_id in history_shop_link_seed_dict:
        for history_link_seed_list in history_shop_link_seed_dict[shop_id]:
            # 子集检查
            if set(seed_shop_list) <= set(history_link_seed_list):
                filter_sign = 1
                break
    if filter_sign == 0:
        valid_shop_list.append(shop_id)

# 保留有效群组
if len(valid_shop_list) > 0:
    valid_idx_list.append(idx)
</script>

    <script type="text/template" id="content-RuleScript-simplified" data-name="全域风险团伙审核_召回_团伙规则过滤_假货.py"
        data-lang="python"># %% 核心逻辑: 群组切分和采样
# 大群组最多10个商家，优先级: 种子(1) > 有更新商品(2) > 随机

def split_chunks(n, lst):
    return [lst[i:i+n] for i in range(0, len(lst), n)]

# 排序逻辑: is_seed DESC, has_new_product DESC, random
all_shop_list.sort(key=lambda x: (x[1], x[2], random.random()), reverse=True)

# 分块
sub_group_list = split_chunks(10, all_shop_list)

# 构建结果 JSON
for group_info in group_output:
    shop_info_list = []
    for shop_id in group_info['group_shop_list']:
        # ... 构建包含罚单详情的 shop_infos ...
        seed_penalize_info_list = []
        # 解析品牌、罚单类型等
        other_seed_shop_relation_list = []
        # 构建种子关系 (highprec/strong)
        shop_info_list.append({...})
    
    # 输出到 JSON
    'shop_infos': json.dumps(shop_info_list, ensure_ascii=False)
</script>

    <script type="text/template" id="content-FilterSQL-simplified" data-name="全域风险团伙审核_召回_团伙种子过滤_假货.sql"
        data-lang="sql">-- 核心逻辑: 初筛条件
-- 要求:
-- 1. 至少1个假货种子 (group_jh_seed_cnt >= 1)
-- 2. 至少1个严重种子 (group_worth_reejctandpenalize_jh_seed_cnt >= 1)
-- 3. 至少3个待审核商家 (group_has_auditproduct_shop_cnt >= 3)

INSERT OVERWRITE TABLE ...
SELECT ...
FROM (
    SELECT 
        ...,
        count(CASE WHEN is_jh_seed = 1 THEN shop_id END) OVER(...) as group_jh_seed_cnt,
        count(CASE WHEN is_jh_seed = 1 AND ... IS NULL THEN shop_id END) OVER(...) as group_worth_reejctandpenalize_jh_seed_cnt,
        count(CASE WHEN is_jh_seed = 1 OR p60d_update_product_cnt >= 1 THEN shop_id END) OVER(...) as group_has_auditproduct_shop_cnt
    FROM origin_table
    LEFT JOIN penalty_tickets ON ...
)
WHERE group_jh_seed_cnt >= 1
  AND group_worth_reejctandpenalize_jh_seed_cnt >= 1
  AND group_has_auditproduct_shop_cnt >= 3
</script>

    <script type="text/template" id="content-BaseDataSQL-simplified" data-name="全域风险团伙审核_召回_团伙基础数据.sql" data-lang="sql">-- 核心逻辑: 组装宽表
-- 关联: 团伙关系 -> 商家属性 -> 罚单信息 -> 商品信息 -> 订单数据

WITH group_base_data AS (
    -- 获取 >= 3 商家的团伙
    SELECT group_type, group_id, shop_id, ...
    FROM shop_fusion_link_group_v1
    WHERE group_size >= 3
),
shop_main_cate AS (
    -- 商家主营类目
    SELECT shop_id, cate_team FROM ...
),
seed_penalize_data AS (
    -- 种子罚单数据（带商品ID解析）
    SELECT shop_id, rule_id, penalize_id, penalize_product_id, ...
    FROM penalty_tickets
    LEFT JOIN parsed_product_info ON ...
)
-- 最终组装
INSERT OVERWRITE TABLE ... PARTITION (date = '${date}')
SELECT
    A.group_id, A.shop_id,
    B1.is_jh_seed,  -- 假货种子标记
    B1.seed_penalize_info,  -- 罚单详情JSON
    C.product_cnt, C.p60d_update_product_cnt,  -- 商品统计
    D.p60d_pay_order_cnt,  -- 订单统计
    E.group_id as strong_group_id  -- 强关联群组ID
FROM group_base_data A
LEFT JOIN seed_penalize_data B1 ON A.shop_id = B1.shop_id
LEFT JOIN product_data C ON A.shop_id = C.shop_id
LEFT JOIN order_data D ON A.shop_id = D.shop_id
LEFT JOIN strong_group E ON A.shop_id = E.shop_id
</script>

    <script type="text/template" id="content-ParseScript-simplified" data-name="底线违规商品映射解析_假货.py" data-lang="python"># %% 核心逻辑: 从罚单中解析商品ID
# 处理混乱的JSON和各种分隔符格式

# 查询原始罚单
shop_jh_seed_penalize_sql = """
SELECT A.shop_id, A.rule_id, A.ticket_id, A.ticket_create_time,
       B.final_factor_info_list_map
FROM dwd_gvn_penalty_ticket_info_df A
LEFT JOIN dwd_gvn_penalty_judge_record_df B ON A.uuid = B.uuid
WHERE A.date = '${date}' AND A.status = 1 AND ...
"""

# 解析循环
output = []
for idx in range(len(shop_jh_seed_penalize)):
    product_id_list = []
    
    # 尝试解析 'recall_product_verify_result'
    try:
        recall_result = json.loads(final_factor_info_list_map.get('recall_product_verify_result'))
        for order in recall_result.get('verified_order_info', []):
            product_id_sentence = order['product_id'].replace(...).replace(...)
            product_id_list += [int(i) for i in product_id_sentence.split(',')]
    except: pass
    
    # 尝试解析 'violation_detail:commodity_id'
    try:
        commodity_id = final_factor_info_list_map.get('violation_detail:commodity_id')
        product_id_list += [int(i) for i in commodity_id.replace(...).split(',')]
    except: pass
    
    # 尝试解析 'violation_detail:product_id'
    try:
        product_id = final_factor_info_list_map.get('violation_detail:product_id')
        product_id_list += [int(i) for i in product_id.replace(...).split(',')]
    except: pass
    
    # 去重并输出
    product_id_list = list(set(product_id_list))
    for product_id in product_id_list:
        output.append({
            'shop_id': shop_id,
            'penalize_id': penalize_id,
            'product_id': product_id
        })
</script>

    <script>
        // State Management
        const state = {
            currentMode: 'simplified',
            currentNodeId: null,
            originalContentCache: {}
        };

        // Code navigation mapping: flow node ID -> search keyword
        const codeNavigation = {
            "SummaryScript": {
                "LoadToday": "today_data_sql",
                "LoadHistory": "history_data_sql",
                "BuildDict": "history_shop_link_seed_dict",
                "SubsetCheck": "set(seed_shop_list) <= set(history_link_seed_list)",
                "SaveHive": "dataframe2hive"
            },
            "RuleScript": {
                "Load": "groupaudit_shop_recallstrategy_v1_filter_groupshopinfo",
                "Sort": "all_shop_list.sort",
                "Split": "split_chunks",
                "BuildJSON": "shop_info_list"
            },
            "FilterSQL": {
                "Origin": "groupaudit_shop_recallstrategy_v1_origin_groupshopinfo",
                "Window1": "group_jh_seed_cnt",
                "Window2": "group_has_auditproduct_shop_cnt",
                "Window3": "group_worth_reejctandpenalize_jh_seed_cnt",
                "Filter": "WHERE"
            },
            "BaseDataSQL": {
                "CTE1": "group_base_data",
                "CTE2": "shop_main_cate",
                "CTE3": "seed_penalize_data",
                "Join1": "LEFT JOIN"
            },
            "ParseScript": {
                "Query": "shop_jh_seed_penalize_sql",
                "Try1": "recall_product_verify_result",
                "Try2": "violation_detail:commodity_id",
                "Try3": "violation_detail:product_id"
            }
        };

        // File mapping for Original mode
        const fileMapping = {
            "SummaryScript": { filename: "全域风险团伙审核_召回_汇总.py", lang: "python" },
            "RuleScript": { filename: "全域风险团伙审核_召回_团伙规则过滤_假货.py", lang: "python" },
            "FilterSQL": { filename: "全域风险团伙审核_召回_团伙种子过滤_假货.sql", lang: "sql" },
            "BaseDataSQL": { filename: "全域风险团伙审核_召回_团伙基础数据.sql", lang: "sql" },
            "ParseScript": { filename: "底线违规商品映射解析_假货.py", lang: "python" }
        };

        const nodeMapping = {
            "SummaryScript": "content-SummaryScript",
            "RuleScript": "content-RuleScript",
            "FilterSQL": "content-FilterSQL",
            "BaseDataSQL": "content-BaseDataSQL",
            "ParseScript": "content-ParseScript"
        };

        mermaid.initialize({
            startOnLoad: true,
            theme: 'base',
            securityLevel: 'loose',
            flowchart: { useMaxWidth: false, htmlLabels: true, curve: 'basis' }
        });

        document.addEventListener('DOMContentLoaded', async () => {
            setTimeout(() => {
                bindInteractivity();
                initResizer();
            }, 1000);
        });

        function initResizer() {
            const resizer = document.getElementById('drag-handle');
            const leftSide = document.getElementById('left-pane');
            const rightSide = document.getElementById('right-pane');
            const container = document.getElementById('main-split-view');
            let x = 0, leftWidth = 0;
            const mouseDownHandler = function (e) {
                x = e.clientX;
                leftWidth = leftSide.getBoundingClientRect().width;
                document.addEventListener('mousemove', mouseMoveHandler);
                document.addEventListener('mouseup', mouseUpHandler);
                document.body.classList.add('resizing');
                resizer.classList.add('resizing');
            };
            const mouseMoveHandler = function (e) {
                const dx = e.clientX - x;
                const newLeftWidth = ((leftWidth + dx) * 100) / container.getBoundingClientRect().width;
                if (newLeftWidth > 20 && newLeftWidth < 80) {
                    leftSide.style.width = newLeftWidth + '%';
                    rightSide.style.width = (100 - newLeftWidth) + '%';
                }
            };
            const mouseUpHandler = function () {
                document.removeEventListener('mousemove', mouseMoveHandler);
                document.removeEventListener('mouseup', mouseUpHandler);
                document.body.classList.remove('resizing');
                resizer.classList.remove('resizing');
            };
            resizer.addEventListener('mousedown', mouseDownHandler);
        }

        function bindInteractivity() {
            // Bind main graph nodes
            Object.keys(nodeMapping).forEach(nodeId => {
                document.querySelectorAll('#main-graph g.node').forEach(node => {
                    if (node.id.indexOf(nodeId) !== -1 || node.id === nodeId) {
                        node.style.cursor = 'pointer';
                        node.classList.add('hover:opacity-75');
                        node.onclick = (e) => {
                            e.stopPropagation();
                            document.querySelectorAll('#main-graph g.node path, #main-graph g.node rect').forEach(p => p.style.strokeWidth = '1px');
                            const shape = node.querySelector('path') || node.querySelector('rect');
                            if (shape) shape.style.strokeWidth = '3px';

                            state.currentNodeId = nodeId;
                            renderContent();
                            updateGraph();
                        };
                    }
                });
            });
        }

        function bindDetailGraphInteractivity() {
            if (!state.currentNodeId || state.currentMode !== 'original') return;

            const detailGraph = document.getElementById(`detail-${state.currentNodeId}`);
            if (!detailGraph) return;

            // Make detail graph nodes clickable for code navigation
            detailGraph.querySelectorAll('g.node').forEach(node => {
                const nodeId = node.id.split('-').pop(); // Extract node ID from full ID
                const navMapping = codeNavigation[state.currentNodeId];

                if (navMapping && navMapping[nodeId]) {
                    node.style.cursor = 'pointer';
                    node.classList.add('hover:opacity-75');

                    node.onclick = (e) => {
                        e.stopPropagation();
                        navigateToCode(navMapping[nodeId]);

                        // Visual feedback
                        detailGraph.querySelectorAll('g.node path, g.node rect').forEach(p => p.style.strokeWidth = '1px');
                        const shape = node.querySelector('path') || node.querySelector('rect');
                        if (shape) shape.style.strokeWidth = '3px';
                    };
                }
            });
        }

        function navigateToCode(keyword) {
            const codeBlock = document.getElementById('code-content');
            const codeText = codeBlock.textContent;

            // Find keyword in code
            const index = codeText.indexOf(keyword);
            if (index === -1) {
                console.warn('Keyword not found:', keyword);
                return;
            }

            // Count line number
            const beforeText = codeText.substring(0, index);
            const lineNumber = (beforeText.match(/\n/g) || []).length + 1;

            // Scroll to line
            const lineElement = document.querySelector(`.hljs-ln-line[data-line-number="${lineNumber}"]`);
            if (lineElement) {
                lineElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Add highlight effect
                lineElement.classList.add('highlight-line');
                setTimeout(() => lineElement.classList.remove('highlight-line'), 2000);
            }
        }

        function updateGraph() {
            const mainGraph = document.getElementById('main-graph');
            const title = document.getElementById('graph-title');

            if (state.currentMode === 'original' && state.currentNodeId) {
                // Hide main graph, show detail graph
                mainGraph.classList.add('hidden');

                // Show specific detail graph
                document.querySelectorAll('[id^="detail-"]').forEach(g => g.classList.add('hidden'));
                const detailGraph = document.getElementById(`detail-${state.currentNodeId}`);
                if (detailGraph) {
                    detailGraph.classList.remove('hidden');
                    title.textContent = 'Logic Flow';

                    // Re-render mermaid for this graph
                    setTimeout(() => {
                        bindDetailGraphInteractivity();
                    }, 500);
                }
            } else {
                // Show main graph
                mainGraph.classList.remove('hidden');
                document.querySelectorAll('[id^="detail-"]').forEach(g => g.classList.add('hidden'));
                title.textContent = 'Dependency Graph';
            }
        }

        function switchMode(mode) {
            state.currentMode = mode;

            const simBtn = document.getElementById('tab-simplified');
            const oriBtn = document.getElementById('tab-original');

            if (mode === 'simplified') {
                simBtn.className = "px-3 py-1 text-[10px] font-medium rounded-md text-white bg-brand-600 transition-all";
                oriBtn.className = "px-3 py-1 text-[10px] font-medium rounded-md text-slate-400 hover:text-slate-200 transition-all";
            } else {
                oriBtn.className = "px-3 py-1 text-[10px] font-medium rounded-md text-white bg-brand-600 transition-all";
                simBtn.className = "px-3 py-1 text-[10px] font-medium rounded-md text-slate-400 hover:text-slate-200 transition-all";
            }

            renderContent();
            updateGraph();
        }

        async function renderContent() {
            if (!state.currentNodeId) return;

            const codeBlock = document.getElementById('code-content');
            let code, lang, name;

            if (state.currentMode === 'simplified') {
                const targetId = `${nodeMapping[state.currentNodeId]}-simplified`;
                const template = document.getElementById(targetId);
                if (!template) {
                    console.error("Template not found:", targetId);
                    return;
                }
                code = template.textContent.trim();
                lang = template.getAttribute('data-lang');
                name = template.getAttribute('data-name');
            } else {
                const fileInfo = fileMapping[state.currentNodeId];
                if (!fileInfo) {
                    console.error("File mapping not found for:", state.currentNodeId);
                    return;
                }

                if (!state.originalContentCache[state.currentNodeId]) {
                    try {
                        codeBlock.textContent = "// Loading...";
                        codeBlock.className = "hljs language-plaintext code-placeholder";

                        const response = await fetch(fileInfo.filename);
                        if (!response.ok) {
                            throw new Error(`Failed to load ${fileInfo.filename}`);
                        }
                        const content = await response.text();
                        state.originalContentCache[state.currentNodeId] = content;
                    } catch (error) {
                        codeBlock.textContent = `// Error loading file: ${error.message}\n// Make sure you're accessing via http://localhost:8000/index.html`;
                        codeBlock.className = "hljs language-plaintext";
                        console.error(error);
                        return;
                    }
                }

                code = state.originalContentCache[state.currentNodeId];
                lang = fileInfo.lang;
                name = fileInfo.filename;
            }

            codeBlock.textContent = code;
            codeBlock.classList.remove('code-placeholder');
            codeBlock.removeAttribute('data-highlighted');
            codeBlock.className = `language-${lang} hljs`;

            hljs.highlightElement(codeBlock);
            hljs.lineNumbersBlock(codeBlock);

            document.getElementById('current-filename').textContent = name || "Unknown";
            document.getElementById('current-filename').setAttribute('title', name);
            document.getElementById('lang-tag').textContent = lang.toUpperCase();
        }

        function copyCode() {
            const codeBlock = document.getElementById('code-content');
            const text = codeBlock.textContent || codeBlock.innerText;
            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target;
                const oldText = btn.textContent;
                btn.textContent = 'COPIED!';
                btn.classList.add('bg-green-600');
                setTimeout(() => {
                    btn.textContent = oldText;
                    btn.classList.remove('bg-green-600');
                }, 2000);
            });
        }

        window.onerror = function (msg, url, line) {
            const status = document.getElementById('status-indicator');
            status.className = "flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-red-50 text-red-700 text-xs font-medium border border-red-100";
            status.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-red-500"></span> Error`;
            return false;
        };
    </script>
</body>

</html>