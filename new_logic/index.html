<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Editor - New Logic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.1/mermaid.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <!-- Monaco Editor Loader -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e' }
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-[#1e1e1e] text-gray-300 h-screen flex flex-col overflow-hidden">

    <!-- Header (Original Style) -->
    <header
        class="bg-white border-b border-slate-200 shadow-sm z-10 px-6 py-4 flex justify-between items-center h-16 shrink-0">
        <div class="flex items-center gap-3">
            <div class="h-8 w-8 bg-brand-600 rounded-lg flex items-center justify-center text-white font-bold text-lg">G
            </div>
            <div>
                <h1 class="text-base font-bold text-slate-800">全域风险团伙审核实时化</h1>
                <p class="text-[10px] text-slate-500 font-medium uppercase tracking-wider">Real-time Architecture
                    Visualization</p>
            </div>
        </div>
        <div class="flex items-center gap-2 text-sm text-slate-500">
            <span id="status-indicator"
                class="flex items-center gap-1.5 px-2 py-0.5 rounded-full bg-green-50 text-green-700 text-xs font-medium border border-green-100">
                <span class="w-1.5 h-1.5 rounded-full bg-green-500"></span> Ready
            </span>
        </div>
    </header>

    <!-- Main Layout (Split Pane) -->
    <div class="flex-1 flex overflow-hidden" id="main-split-view">

        <!-- Left Pane: Mermaid Graph -->
        <main class="flex-1 relative bg-slate-50 flex flex-col min-w-[300px]" id="left-pane" style="width: 50%;">
            <div id="graph-header-container"
                class="absolute top-4 left-4 z-10 bg-white/90 backdrop-blur px-3 py-1.5 rounded-full text-xs font-semibold text-brand-600 shadow-sm border border-brand-100 flex items-center gap-2 transition-colors duration-200">
                <button id="back-btn" class="hidden flex items-center justify-center p-1 -ml-1 rounded-full transition"
                    title="返回">
                    <svg class="w-4 h-4 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                </button>
                <span id="graph-title">Dependency Graph</span>
            </div>

            <div id="graph-container" class="flex-1 w-full h-full p-4 overflow-auto"></div>
        </main>

        <!-- Resizer -->
        <div class="resizer" id="drag-handle"></div>

        <!-- Right Pane: VS Code Style Editor -->
        <aside class="relative flex flex-col min-w-[300px] bg-[#1e1e1e]" id="right-pane" style="width: 50%;">

            <!-- VS Code Internal Layout (Sidebar + Editor) -->
            <div class="flex-1 flex overflow-hidden">
                <!-- Internal Sidebar -->
                <div class="w-64 bg-[#252526] flex flex-col border-r border-[#1e1e1e]" id="vscode-sidebar">
                    <div id="explorer-header"
                        class="h-9 px-0 flex items-center text-xs font-bold uppercase tracking-wider text-gray-400 bg-[#252526] transition-colors">
                        <button id="sidebar-toggle"
                            class="w-9 h-full flex items-center justify-center hover:text-white transition-colors"
                            title="Toggle Sidebar">
                            <svg class="w-5 h-5 header-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                                </path>
                            </svg>
                        </button>
                        <span class="header-text pl-1">Explorer</span>
                    </div>
                    <div id="file-tree" class="flex-1 overflow-y-auto py-2"></div>
                </div>

                <!-- Internal Editor Area -->
                <div class="flex-1 flex flex-col bg-[#1e1e1e] relative min-w-0" id="vscode-editor-area">
                    <!-- Tabs -->
                    <div class="h-9 bg-[#2d2d2d] flex items-center px-0 overflow-x-auto" id="editor-tabs"></div>
                    <!-- Breadcrumbs -->
                    <div class="h-6 bg-[#1e1e1e] flex items-center px-4 text-xs text-gray-500 border-b border-[#2d2d2d]"
                        id="editor-breadcrumbs">
                        <span id="breadcrumb-path">Select a file to view</span>
                    </div>
                    <!-- Monaco -->
                    <div id="monaco-container" class="flex-1 w-full relative"></div>
                </div>
            </div>

        </aside>
    </div>

    <!-- Scripts -->
    <script src="state.js"></script>
    <script src="file_tree.js"></script>
    <script src="editor.js"></script>
    <script src="app.js"></script>

    <!-- Graph Definitions (Copied from original) -->
    <script type="text/template" id="graph-main">
 graph TD
     classDef default fill:#fff,stroke:#cbd5e1,stroke-width:1px,rx:6,ry:6,color:#334155;
     classDef origin fill:#eff6ff,stroke:#3b82f6,stroke-width:2px,color:#1e40af;
     classDef process fill:#faf5ff,stroke:#a855f7,stroke-width:2px,color:#6b21a8;
     classDef final fill:#f0fdf4,stroke:#22c55e,stroke-width:2px,color:#166534;
     
     subgraph Level0 ["Level 0: Raw Data"]
         GroupLink["shop_fusion_link_group_v1"]:::origin
         ShopAttr["dim_slr_shop_ext_df"]:::origin
         PenaltyTicket["dwd_gvn_penalty_ticket_info_df"]:::origin
         JudgeRecord["dwd_gvn_penalty_judge_record_df"]:::origin
         OrderData["dm_aftersale_order_status_df"]:::origin
     end
 
     subgraph Level1 ["Level 1: Parsing"]
         ParseScript["底线违规商品映射解析_*.py"]:::process
         ParsedSeed["parsed_product_info"]
     end
 
     subgraph Level2 ["Level 2: Assembly"]
         BaseDataSQL["全域风险团伙审核_召回_团伙基础数据.sql"]:::process
         OriginGroup["origin_groupshopinfo"]
     end
 
     subgraph Level3 ["Level 3: Pre-Filtering"]
         FilterSQL["全域风险团伙审核_召回_团伙种子过滤_*.sql"]:::process
         FilterGroup["filter_groupshopinfo"]
     end
 
     subgraph Level4 ["Level 4: Python Rules"]
         RuleScript["全域风险团伙审核_召回_团伙规则过滤_*.py"]:::process
         ResultGroup["result_groupshopinfo"]
     end
 
     subgraph Level5 ["Level 5: Aggregation"]
         SummaryScript["全域风险团伙审核_召回_汇总.py"]:::final
         FinalTable["groupshopinfo"]:::final
         HistoryData[("History 7d")]
     end
 
     PenaltyTicket --> ParseScript
     JudgeRecord --> ParseScript
     ParseScript --> ParsedSeed
     GroupLink --> BaseDataSQL
     ShopAttr --> BaseDataSQL
     OrderData --> BaseDataSQL
     ParsedSeed --> BaseDataSQL
     BaseDataSQL --> OriginGroup
     OriginGroup --> FilterSQL
     PenaltyTicket --> FilterSQL
     FilterSQL --> FilterGroup
     FilterGroup --> RuleScript
     RuleScript --> ResultGroup
     ResultGroup --> SummaryScript
     HistoryData --> SummaryScript
     SummaryScript --> FinalTable
 </script>

    <script type="text/template" id="graph-SummaryScript">
 graph TD
     classDef data fill:#e0f2fe,stroke:#0284c7,stroke-width:2px;
     classDef logic fill:#fae8ff,stroke:#a855f7,stroke-width:2px;
     classDef output fill:#dcfce7,stroke:#16a34a,stroke-width:2px;
     
     Start(("开始")):::logic
     LoadToday["读取今日数据<br/>today_data_sql"]:::data
     LoadHistory["读取历史数据<br/>history_data_sql"]:::data
     BuildDict["构建历史字典<br/>history_shop_link_seed_dict"]:::logic
     FilterLoop["遍历今日数据"]:::logic
     SubsetCheck{"子集检查<br/>current ⊆ history?"}:::logic
     Filter["过滤"]:::logic
     Keep["保留"]:::logic
     Collect["收集有效数据"]:::logic
     SaveHive["保存到 Hive"]:::output
     
     Start --> LoadToday & LoadHistory
     LoadToday & LoadHistory --> BuildDict
     BuildDict --> FilterLoop
     FilterLoop --> SubsetCheck
     SubsetCheck -->|Yes| Filter
     SubsetCheck -->|No| Keep
     Filter & Keep --> Collect
     Collect --> SaveHive
 </script>

    <script type="text/template" id="graph-RuleScript">
 graph TD
     classDef data fill:#e0f2fe,stroke:#0284c7,stroke-width:2px;
     classDef logic fill:#fae8ff,stroke:#a855f7,stroke-width:2px;
     classDef output fill:#dcfce7,stroke:#16a34a,stroke-width:2px;
     
     Start(("开始")):::logic
     Load["读取筛选后数据"]:::data
     Group["按 group_id 分组"]:::logic
     Sort["排序商家<br/>(seed, new_product, random)"]:::logic
     CheckSize{"size > 10?"}:::logic
     Split["切分子群组"]:::logic
     Keep["保持原样"]:::logic
     BuildJSON["构建 JSON"]:::logic
     SaveHive["保存到 Hive"]:::output
     
     Start --> Load
     Load --> Group
     Group --> Sort
     Sort --> CheckSize
     CheckSize -->|Yes| Split
     CheckSize -->|No| Keep
     Split & Keep --> BuildJSON
     BuildJSON --> SaveHive
 </script>

    <script type="text/template" id="graph-FilterSQL">
 graph TD
     classDef data fill:#e0f2fe,stroke:#0284c7,stroke-width:2px;
     classDef logic fill:#fae8ff,stroke:#a855f7,stroke-width:2px;
     classDef output fill:#dcfce7,stroke:#16a34a,stroke-width:2px;
     
     Start(("开始")):::logic
     Origin["origin_groupshopinfo"]:::data
     Penalty["JOIN penalty_tickets"]:::data
     Window1["计算 group_jh_seed_cnt"]:::logic
     Window2["计算 group_has_auditproduct_shop_cnt"]:::logic
     Window3["计算 group_worth_xxx_cnt"]:::logic
     Filter["WHERE 条件过滤"]:::logic
     Insert["INSERT filter_groupshopinfo"]:::output
     
     Start --> Origin
     Origin --> Penalty
     Penalty --> Window1
     Window1 --> Window2
     Window2 --> Window3
     Window3 --> Filter
     Filter --> Insert
 </script>

    <script type="text/template" id="graph-BaseDataSQL">
 graph TD
     classDef data fill:#e0f2fe,stroke:#0284c7,stroke-width:2px;
     classDef logic fill:#fae8ff,stroke:#a855f7,stroke-width:2px;
     classDef output fill:#dcfce7,stroke:#16a34a,stroke-width:2px;
     
     Start(("开始")):::logic
     CTE1["CTE: group_base_data<br/><i>(FROM shop_fusion_link_group_v1)</i>"]:::data
     CTE2["CTE: shop_main_cate<br/><i>(主营类目)</i>"]:::data
     CTE3["CTE: seed_penalize_data<br/><i>(罚单+商品解析)</i>"]:::data
     Join1["JOIN 假货罚单<br/><i>(使用 seed_penalize_data B1)</i>"]:::logic
     Join2["JOIN 劣质罚单<br/><i>(使用 seed_penalize_data B2)</i>"]:::logic
     Join3["JOIN 虚假宣传罚单<br/><i>(使用 seed_penalize_data B3)</i>"]:::logic
     Join4["JOIN 商品信息<br/><i>(dim_prd_product_base_df C)</i>"]:::logic
     Join5["JOIN 订单信息<br/><i>(shop_order_order_data D)</i>"]:::logic
     Join6["JOIN 强关联群组<br/><i>(shop_same_people_shops_group E)</i>"]:::logic
     Insert["INSERT origin_groupshopinfo"]:::output
     
     Start --> CTE1 & CTE2 & CTE3
     CTE1 & CTE3 --> Join1
     Join1 --> Join2 --> Join3
     Join3 --> Join4 --> Join5 --> Join6
     Join6 --> Insert
 </script>

    <script type="text/template" id="graph-ParseScript">
 graph TD
     classDef data fill:#e0f2fe,stroke:#0284c7,stroke-width:2px;
     classDef logic fill:#fae8ff,stroke:#a855f7,stroke-width:2px;
     classDef output fill:#dcfce7,stroke:#16a34a,stroke-width:2px;
     
     Start(("开始")):::logic
     Query["查询罚单数据"]:::data
     Loop["遍历每条罚单"]:::logic
     Try1["解析 recall_product_verify_result"]:::logic
     Try2["解析 violation_detail:commodity_id"]:::logic
     Try3["解析 violation_detail:product_id"]:::logic
     Dedupe["去重 product_id_list"]:::logic
     Expand["展开为多行"]:::logic
     SaveHive["保存到 Hive"]:::output
     
     Start --> Query
     Query --> Loop
     Loop --> Try1 & Try2 & Try3
     Try1 & Try2 & Try3 --> Dedupe
     Dedupe --> Expand
     Expand --> SaveHive
 </script>
</body>

</html>